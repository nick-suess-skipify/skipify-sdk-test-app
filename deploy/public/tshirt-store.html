<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skipify T-Shirt Store | Chat-Powered Checkout</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
        }

        .cart-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .cart-badge {
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        /* Main Layout */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 15px;
            min-height: 70vh;
            padding: 15px;
        }
        
        .left-column {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .right-column {
            position: sticky;
            top: 20px;
            height: fit-content;
        }

        /* Products Section */
        .products-section {
            padding: 20px;
        }

        /* Receipt Section */
        .receipt-container {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            max-width: 500px;
            margin: 0 auto;
        }

        .receipt-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .receipt-title {
            font-size: 24px;
            color: #28a745;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .receipt-subtitle {
            color: #6c757d;
            font-size: 14px;
        }

        .receipt-section {
            margin-bottom: 20px;
        }

        .receipt-section h3 {
            color: #2c3e50;
            font-size: 16px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #dee2e6;
        }

        .receipt-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dotted #dee2e6;
        }

        .receipt-item:last-child {
            border-bottom: none;
        }

        .receipt-item-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .receipt-item-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .receipt-item-qty {
            font-size: 12px;
            color: #666;
        }

        .receipt-item-price {
            font-weight: 600;
            color: #27ae60;
        }

        .receipt-total {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .receipt-total-amount {
            display: flex;
            justify-content: space-between;
            font-size: 18px;
            font-weight: bold;
            color: #28a745;
        }

        .receipt-info {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .receipt-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .receipt-info-item:last-child {
            margin-bottom: 0;
        }

        .receipt-actions {
            text-align: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
        }

        .new-order-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .new-order-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .section-title {
            font-size: 24px;
            color: #2c3e50;
            margin-bottom: 24px;
            text-align: center;
            font-weight: 600;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 24px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .product-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            border-color: #3498db;
        }

        .product-image {
            width: 100%;
            height: 200px;
            overflow: hidden;
            position: relative;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .product-card:hover .product-image img {
            transform: scale(1.05);
        }

        .product-details {
            padding: 16px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .product-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
            line-height: 1.3;
        }

        .product-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
            line-height: 1.4;
            flex: 1;
        }

        .product-price {
            font-size: 18px;
            font-weight: 700;
            color: #27ae60;
            margin-bottom: 12px;
        }

        .add-to-cart {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .add-to-cart:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        /* Chat Section */
        .chat-section {
            background: #f8f9fa;
            border-left: 3px solid #3498db;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: #3498db;
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 600px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: white;
        }

        .message {
            margin-bottom: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 90%;
            line-height: 1.3;
            font-size: 14px;
        }

        .message.user {
            background: #3498db;
            color: white;
            margin-left: auto;
        }

        .message.assistant {
            background: #ecf0f1;
            color: #2c3e50;
        }

        .message.system {
            background: #f39c12;
            color: white;
            font-size: 14px;
            font-style: italic;
        }

        /* Embedded Component Styling */
        .component-message {
            max-width: 98% !important;
            margin: 5px 0 !important;
        }

        .embedded-component-container {
            background: #ffffff;
            border: 2px solid #e3f2fd;
            border-radius: 8px;
            padding: 8px;
            margin: 5px 0;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
            min-height: 80px;
            max-height: 200px;
            overflow: hidden;
            position: relative;
        }

        .component-loading {
            text-align: center;
            color: #666;
            font-style: italic;
            margin: 15px 0;
            font-size: 14px;
        }

        /* Skipify component iframe styling - COMPACT */
        .embedded-component-container iframe {
            width: 100% !important;
            border: none !important;
            border-radius: 4px;
            min-height: 120px !important;
            max-height: 160px !important;
            height: 140px !important;
        }

        /* Authentication component specific styling - INCREASED HEIGHT */
        .embedded-component-container.auth-component {
            border-color: #4caf50;
            background: linear-gradient(145deg, #f8fff8, #ffffff);
            max-height: 350px !important;
            min-height: 300px !important;
            height: 320px !important;
        }

        /* Payment carousel specific styling - INCREASED HEIGHT */
        .embedded-component-container.carousel-component {
            border-color: #2196f3;
            background: linear-gradient(145deg, #f0f8ff, #ffffff);
            max-height: 350px !important;
            min-height: 280px !important;
            height: 300px !important;
        }

        /* Ultra-compact component styling for chat flow */
        .embedded-component-container.inline-component {
            margin: 3px 0 !important;
            padding: 5px !important;
            min-height: 100px !important;
            max-height: 160px !important;
            height: 140px !important;
        }

        .embedded-component-container.inline-component iframe {
            min-height: 110px !important;
            max-height: 140px !important;
            height: 130px !important;
        }

        /* Inline authentication with increased height */
        .embedded-component-container.auth-component.inline-component {
            max-height: 350px !important;
            height: 320px !important;
        }

        .embedded-component-container.auth-component.inline-component iframe {
            height: 300px !important;
            max-height: 320px !important;
        }

        /* Inline carousel with increased height */
        .embedded-component-container.carousel-component.inline-component {
            max-height: 350px !important;
            height: 300px !important;
        }

        .embedded-component-container.carousel-component.inline-component iframe {
            height: 280px !important;
            max-height: 300px !important;
        }

        .chat-input {
            padding: 20px;
            border-top: 1px solid #ecf0f1;
            background: white;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .chat-input-field {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #ecf0f1;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
        }

        .chat-input-field:focus {
            border-color: #3498db;
        }

        .send-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .send-button:hover {
            background: #2980b9;
        }

        /* Cart Summary */
        .cart-summary {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .cart-summary h3 {
            background: #f8f9fa;
            color: #2c3e50;
            padding: 16px;
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            border-bottom: 1px solid #e0e0e0;
        }

        .cart-total {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #27ae60;
            padding: 0 16px;
        }

        .cart-items {
            max-height: 350px;
            overflow-y: auto;
            border-bottom: 1px solid #e0e0e0;
        }

        .cart-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .cart-item-price {
            font-size: 12px;
            color: #666;
        }

        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .quantity-btn {
            background: none;
            border: none;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #3498db;
            transition: background 0.2s ease;
            min-width: 28px;
        }

        .quantity-btn:hover {
            background: #e9ecef;
        }

        .quantity {
            padding: 4px 8px;
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            min-width: 24px;
            text-align: center;
        }

        .cart-item-total {
            font-size: 14px;
            font-weight: 600;
            color: #27ae60;
            min-width: 60px;
            text-align: right;
        }

        .remove-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: background 0.2s ease;
        }

        .remove-btn:hover {
            background: #c0392b;
        }

        .empty-cart {
            color: #999;
            font-style: italic;
            padding: 24px 16px;
            text-align: center;
            font-size: 14px;
        }

        .quick-checkout {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin: 16px 0;
        }

        .quick-checkout:hover {
            background: #2980b9;
        }

        /* Integrated Skipify Assistant Section */
        .skipify-assistant-section {
            margin-top: 0;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .assistant-header {
            background: #f8f9fa;
            color: #2c3e50;
            padding: 16px;
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            border-bottom: 1px solid #e0e0e0;
        }

        .assistant-container {
            display: flex;
            flex-direction: column;
            height: 650px;
            background: white;
        }

        .assistant-container .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: white;
            max-height: 500px;
        }

        .assistant-container .chat-input {
            padding: 20px;
            border-top: 1px solid #ecf0f1;
            background: #f8f9fa;
        }

        .component-containers {
            margin-top: 15px;
        }

        .skipify-component-container {
            background: #ffffff;
            border: 2px solid #e3f2fd;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            min-height: 200px;
            display: none; /* Hidden by default, shown when needed */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .skipify-component-container.active {
            display: block;
        }

        .skipify-component-container iframe {
            width: 100% !important;
            height: 100% !important;
            border: none !important;
            min-height: 300px;
        }

        /* Legacy Skipify Components (kept for compatibility) */
        .skipify-components {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #3498db;
        }

        .component-container {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #ecf0f1;
        }

        .component-title {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        /* Helper Styles */
        .empty-cart {
            color: #7f8c8d;
            font-style: italic;
        }

        .success-message {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .left-column {
                order: 1;
            }
            
            .right-column {
                order: 2;
                position: static;
            }
            
            .skipify-assistant-section {
                margin-top: 20px;
            }
            
            .assistant-container {
                height: 500px;
            }
            
            .assistant-container .chat-messages {
                max-height: 350px;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 15px 20px;
                flex-direction: column;
                gap: 15px;
            }
            
            .products-section {
                padding: 20px;
            }
            
            .products-grid {
                grid-template-columns: 1fr;
                gap: 20px;
                max-width: none;
            }
        }

        @media (max-width: 1024px) and (min-width: 769px) {
            .products-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                Skipify T-Shirt Store
            </div>
            <div class="cart-info">
                <span>Cart: $<span id="cart-total">0.00</span></span>
                <div class="cart-badge" id="cart-count">0</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Column: Products + Skipify Assistant -->
            <div class="left-column">
            <!-- Products Section -->
            <div class="products-section">
                <h1 class="section-title">Premium T-Shirts Collection</h1>
                
                <div class="products-grid" id="products-grid">
                    <!-- Products will be loaded here -->
                </div>
                    </div>

                <!-- Integrated Skipify Assistant & Components Section -->
                <div class="skipify-assistant-section">
                    <div class="assistant-header">
                        Skipify Assistant - Integrated Checkout Experience
                </div>

                    <div class="assistant-container">
                    <div class="chat-messages" id="chat-messages">
                                                    <div class="message assistant">
                                **Welcome to the Skipify T-Shirt Store!**
                                
                                I can help you shop and pay quickly and securely with Skipify Checkout.
                                
                                **Try saying:**
                                ‚Ä¢ *"What T-shirts do you have?"*
                                ‚Ä¢ *"Do you have Classic Cotton Tees?"*
                                ‚Ä¢ *"Add 2 Premium Polo Shirts to my cart"*
                                ‚Ä¢ *"Checkout with your-email@example.com"*
                                
                                Browse our collection above, or ask me anything!
                            </div>
                    </div>
                    
                    <div class="chat-input">
                        <div class="input-group">
                            <input 
                                type="text" 
                                id="user-input" 
                                class="chat-input-field" 
                                placeholder="Ask about products, add to cart, or checkout..."
                                onkeypress="handleKeyPress(event)"
                            >
                            <button class="send-button" onclick="sendMessage()">Send</button>
                        </div>
                        
                        <div style="margin-top: 10px; text-align: center;">
                                <button onclick="createSession()" style="background: #27ae60; color: white; border: none; padding: 8px 16px; border-radius: 15px; font-size: 12px; cursor: pointer;">
                                    New Chat Session
                            </button>
                        </div>
                    </div>


                    </div>
                </div>
            </div>
            
            <!-- Right Column: Shopping Cart -->
            <div class="right-column">
                <div class="cart-summary">
                    <h3>Shopping Cart</h3>
                    <div class="cart-total">Total: $<span id="display-total">0.00</span></div>
                    
                    <div class="cart-items" id="cart-items">
                        <div class="empty-cart">Your cart is empty</div>
                    </div>

                    <button class="quick-checkout" onclick="startChatShopping()">
                        Chat to Shop
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration Script -->
    <script src="config.js"></script>

    <!-- Skipify SDK - Dynamic Loading -->
    <script>
        // Script loading monitor variables
        let scriptLoaded = false;
        let scriptFailed = false;

        // Load Skipify SDK dynamically (same approach as working test page)
        console.log('Loading Skipify SDK dynamically...');
        const sdkScript = document.createElement('script');
        sdkScript.src = `https://stagecdn.skipify.com/sdk/components-sdk.js?date=${new Date().getTime()}`;
        sdkScript.onload = function() {
            console.log('Skipify SDK script loaded successfully');
            console.log('Global skipify object available:', typeof window.skipify !== 'undefined');
            scriptLoaded = true;
            
            // Additional verification that skipify is actually available  
            setTimeout(() => {
                if (window.skipify) {
                    console.log('window.skipify confirmed available after script load');
                } else {
                    console.warn('Script loaded but window.skipify not available - may need more time');
                }
            }, 500); // Give it a bit more time
        };
        sdkScript.onerror = function(error) {
            console.error('Failed to load Skipify SDK script:', error);
            scriptFailed = true;
        };
        
        // Add timeout for script loading
        setTimeout(() => {
            if (!scriptLoaded && !scriptFailed) {
                console.error('Script loading timeout - network may be slow');
                scriptFailed = true;
            }
        }, 10000);
        
        document.head.appendChild(sdkScript);
    </script>
    
    <script>
        // T-Shirt Store Configuration
        const PRODUCTS = [
            {
                id: 'classic-tee',
                name: 'Classic Cotton Tee',
                price: 29.99,
                image: 'https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?w=400&h=400&fit=crop&crop=center',
                description: 'Comfortable 100% cotton t-shirt with classic fit'
            },
            {
                id: 'premium-polo',
                name: 'Premium Polo Shirt',
                price: 49.99,
                image: 'https://images.unsplash.com/photo-1596755094514-f87e34085b2c?w=400&h=400&fit=crop&crop=center',
                description: 'Premium cotton polo with modern fit and collar'
            },
            {
                id: 'vintage-graphic',
                name: 'Vintage Graphic Tee',
                price: 34.99,
                image: 'https://images.unsplash.com/photo-1562157873-818bc0726f68?w=400&h=400&fit=crop&crop=center',
                description: 'Features Skipify logo with retro-style vintage appeal'
            }
        ];

        // Shopping Cart
        let cart = [];
        let cartTotal = 0;

        // Skipify Integration
        let currentSession = null;
        let skipifySessionId = null;
        let skipifySDK = null;
        let lookupResults = null;
        let storedChallengeId = null;

        // Initialize Store
        async function initializeStore() {
            loadProducts();
            
            // Try to initialize SDK with retries
            let attempts = 0;
            const maxAttempts = 3;
            
            while (attempts < maxAttempts && !skipifySDK) {
                attempts++;
                console.log(`üîÑ SDK initialization attempt ${attempts}/${maxAttempts}`);
                
                try {
                    await initializeSkipifySDK();
                    if (skipifySDK) {
                        console.log('‚úÖ SDK initialization successful');
                        break;
                    }
                } catch (error) {
                    console.warn(`‚ö†Ô∏è SDK initialization attempt ${attempts} failed:`, error);
                    if (attempts < maxAttempts) {
                        console.log('üîÑ Retrying in 2 seconds...');
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                }
            }
            
            if (!skipifySDK) {
                addMessage('system', 'T-Shirt store loaded but payment system needs attention. Try refreshing the page.');
            } else {
                addMessage('system', 'T-Shirt store loaded! Ask me about products, add items to cart, and checkout via chat.');
            }
        }

        // Load Products
        function loadProducts() {
            const grid = document.getElementById('products-grid');
            grid.innerHTML = '';

            PRODUCTS.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.innerHTML = `
                    <div class="product-image">
                        <img src="${product.image}" alt="${product.name}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDMwMCAzMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMzAwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0xNTAgOTBIMTY1VjEwNUgxODBWMTIwSDE5NVYxNTBIMTgwVjE2NUgxNjVWMTgwSDE1MFYxOTVIMTM1VjE4MEgxMjBWMTY1SDEwNVYxNTBIMTIwVjEyMEgxMzVWMTA1SDE1MFY5MFoiIGZpbGw9IiNEMEQwRDAiLz4KPC9zdmc+'">
                    </div>
                    <div class="product-details">
                        <h3 class="product-name">${product.name}</h3>
                        <p class="product-description">${product.description}</p>
                    <div class="product-price">$${product.price}</div>
                    <button class="add-to-cart" onclick="addToCart('${product.id}')">
                        Add to Cart
                    </button>
                    </div>
                `;
                grid.appendChild(productCard);
            });
        }

        // Display Receipt After Successful Payment
        function displayReceipt(cartItems, paymentResponse, totalAmount) {
            const productsSection = document.querySelector('.products-section');
            
            // Format the completion date
            const completedDate = paymentResponse.data?.completedAt 
                ? new Date(paymentResponse.data.completedAt).toLocaleString()
                : new Date().toLocaleString();

            // Get payment method info (extract card details if available)
            const paymentMethod = paymentResponse.data?.paymentMethod?.details || {};
            const cardInfo = paymentMethod.cardNumber 
                ? `**** **** **** ${paymentMethod.cardNumber.slice(-4)}`
                : 'Skipify Account';
            
            // Generate items HTML
            const itemsHTML = cartItems.map(item => `
                <div class="receipt-item">
                    <div class="receipt-item-details">
                        <span class="receipt-item-name">${item.name}</span>
                        <span class="receipt-item-qty">Qty: ${item.quantity || 1}</span>
                    </div>
                    <span class="receipt-item-price">$${((item.price || 0) * (item.quantity || 1)).toFixed(2)}</span>
                </div>
            `).join('');

            // Create receipt HTML
            productsSection.innerHTML = `
                <div class="receipt-container">
                    <div class="receipt-header">
                        <div class="receipt-title">
                            <span>Order Confirmed!</span>
                        </div>
                        <div class="receipt-subtitle">Thank you for your purchase</div>
                    </div>

                    <div class="receipt-section">
                        <h3>Items Purchased</h3>
                        ${itemsHTML}
                    </div>

                    <div class="receipt-total">
                        <div class="receipt-total-amount">
                            <span>Total Paid:</span>
                            <span>$${totalAmount.toFixed(2)}</span>
                        </div>
                    </div>

                    <div class="receipt-section">
                        <h3>Payment Information</h3>
                        <div class="receipt-info">
                            <div class="receipt-info-item">
                                <span>Payment Method:</span>
                                <span>${cardInfo}</span>
                            </div>
                            <div class="receipt-info-item">
                                <span>Transaction ID:</span>
                                <span>${(paymentResponse.transactionId || paymentResponse.data?.transactionId || 'TXN-' + Date.now()).substring(0, 12)}...</span>
                            </div>
                            <div class="receipt-info-item">
                                <span>PSP Transaction:</span>
                                <span>#${paymentResponse.pspTransactionId || paymentResponse.data?.pspTransactionId || 'PSP-' + Date.now()}</span>
                            </div>
                            <div class="receipt-info-item">
                                <span>Status:</span>
                                <span style="color: #28a745; font-weight: bold;">${paymentResponse.status || paymentResponse.data?.status || 'Completed'}</span>
                            </div>
                        </div>
                    </div>

                    <div class="receipt-section">
                        <h3>Order Details</h3>
                        <div class="receipt-info">
                            <div class="receipt-info-item">
                                <span>Order Date:</span>
                                <span>${completedDate}</span>
                            </div>
                            <div class="receipt-info-item">
                                <span>Order Reference:</span>
                                <span>${paymentResponse.merchantReference || 'N/A'}</span>
                            </div>
                            <div class="receipt-info-item">
                                <span>Store:</span>
                                <span>Premium T-Shirts</span>
                            </div>
                        </div>
                    </div>

                    <div class="receipt-actions">
                        <button class="new-order-btn" onclick="startNewOrder()">
                            Start New Order
                        </button>
                    </div>
                </div>
            `;

            // Scroll to top to show the receipt
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Show Payment Confirmation with "Pay Now" Button
        function showPaymentConfirmation(cardDetails, amount) {
            // ‚úÖ FIXED: Remove any existing payment confirmation dialog first
            const existingConfirmation = document.getElementById('payment-confirmation-container');
            if (existingConfirmation) {
                existingConfirmation.remove();
            }
            
            // Create payment confirmation container
            const confirmationContainer = document.createElement('div');
            confirmationContainer.id = 'payment-confirmation-container';
            confirmationContainer.innerHTML = `
                <div style="background: #f8f9fa; border: 2px solid #28a745; border-radius: 15px; padding: 25px; margin: 20px 0; text-align: center;">
                    <h3 style="color: #28a745; margin-bottom: 20px;">üí≥ Confirm Your Payment</h3>
                    
                    <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <span style="font-weight: bold;">Payment Method:</span>
                            <span>${cardDetails.cardType} ending in ${cardDetails.cardEnding}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 18px; font-weight: bold; color: #28a745;">
                            <span>Total Amount:</span>
                            <span>$${amount.toFixed(2)}</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button id="pay-now-btn" style="
                            background: linear-gradient(135deg, #28a745, #20c997);
                            color: white;
                            border: none;
                            padding: 15px 30px;
                            border-radius: 25px;
                            font-size: 16px;
                            font-weight: bold;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
                        ">
                            üí≥ Pay Now - $${amount.toFixed(2)}
                        </button>
                        
                        <button id="cancel-payment-btn" style="
                            background: #6c757d;
                            color: white;
                            border: none;
                            padding: 15px 30px;
                            border-radius: 25px;
                            font-size: 16px;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        ">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            // Find the appropriate container to append to
            const targetContainer = document.getElementById('carousel-container-placeholder') || 
                                  document.getElementById('ecommerce-carousel-container') ||
                                  document.querySelector('.chat-section');
                                  
            if (targetContainer) {
                targetContainer.appendChild(confirmationContainer);
            }
            
            // Add event listeners
            document.getElementById('pay-now-btn').addEventListener('click', async () => {
                await processConfirmedPayment();
            });
            
            document.getElementById('cancel-payment-btn').addEventListener('click', () => {
                cancelPaymentConfirmation();
            });
            
            // Show success message in chat (with detection for method changes)
            const isMethodChange = existingConfirmation !== null;
            const actionText = isMethodChange ? "Payment method updated!" : "Payment method selected!";
            const emojiPrefix = isMethodChange ? "üîÑ" : "üéØ";
            
            addMessage('assistant', `${emojiPrefix} **${actionText}**

üí≥ **Selected:** ${cardDetails.cardType} ending in ${cardDetails.cardEnding}
üí∞ **Amount:** $${amount.toFixed(2)}

‚úÖ **Ready to proceed!** Click the "Pay Now" button above to complete your payment.`);
        }

        // Process the confirmed payment
        async function processConfirmedPayment() {
            const paymentDetails = window.selectedPaymentDetails;
            if (!paymentDetails) {
                addMessage('assistant', '‚ùå **Error:** Payment details not found. Please try again.');
                return;
            }
            
            // Update UI to show processing
            const payNowBtn = document.getElementById('pay-now-btn');
            if (payNowBtn) {
                payNowBtn.textContent = '‚è≥ Processing...';
                payNowBtn.disabled = true;
            }
            
            addMessage('assistant', 'üí≥ **Processing your payment...** Please wait while we complete the transaction.');
            
            try {
                // Submit payment to Skipify API
                const orderReference = paymentDetails.isChat ? 
                    `chat_order_${Date.now()}` : 
                    `tshirt_order_${Date.now()}`;
                    
                const paymentResult = await submitSkipifyPayment(
                    paymentDetails.paymentId,
                    paymentDetails.sessionId,
                    Math.round(paymentDetails.amount * 100), // Convert to cents
                    orderReference
                );
                
                // Remove confirmation container on success
                const confirmationContainer = document.getElementById('payment-confirmation-container');
                if (confirmationContainer) {
                    confirmationContainer.remove();
                }
                
                // Payment success handled in submitSkipifyPayment function
                console.log('‚úÖ Payment processed successfully:', paymentResult);
                
            } catch (error) {
                console.error('‚ùå Payment processing failed:', error);
                addMessage('assistant', `‚ùå **Payment failed:** ${error.message}\n\nPlease try again or contact support.`);
                
                // Re-enable button on error
                if (payNowBtn) {
                    payNowBtn.textContent = `üí≥ Pay Now - $${paymentDetails.amount.toFixed(2)}`;
                    payNowBtn.disabled = false;
                }
            }
        }

        // Cancel payment confirmation
        function cancelPaymentConfirmation() {
            const confirmationContainer = document.getElementById('payment-confirmation-container');
            if (confirmationContainer) {
                confirmationContainer.remove();
            }
            
            addMessage('assistant', '‚ùå **Payment cancelled.** You can select a different payment method or start over.');
            
            // Clear stored payment details
            window.selectedPaymentDetails = null;
        }

        // Reset Store for New Order - Simple Full Page Refresh
        function startNewOrder() {
            // ‚úÖ SIMPLE & RELIABLE: Full page refresh ensures complete reset
            // This will:
            // - Clear all cart items
            // - Reset all Skipify components and iframes
            // - Reinitialize SDK from scratch
            // - Create fresh chat session
            // - Clear all global state variables
            window.location.reload();
        }

        // Shopping Cart Functions
        function addToCart(productId) {
            const product = PRODUCTS.find(p => p.id === productId);
            if (!product) return;

            // Check if product already exists in cart
            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({ ...product, quantity: 1 });
            }
            
            updateCartDisplay();
            addMessage('system', `Added ${product.name} to cart ($${product.price})`);
        }

        function removeFromCart(productId) {
            const itemIndex = cart.findIndex(item => item.id === productId);
            if (itemIndex > -1) {
                const removed = cart[itemIndex];
                cart.splice(itemIndex, 1);
            updateCartDisplay();
                addMessage('system', `Removed ${removed.name} from cart`);
            }
        }

        function updateQuantity(productId, change) {
            const item = cart.find(item => item.id === productId);
            if (!item) return;

            const newQuantity = item.quantity + change;
            if (newQuantity <= 0) {
                removeFromCart(productId);
            } else {
                item.quantity = newQuantity;
                updateCartDisplay();
            }
        }

        function updateCartDisplay() {
            cartTotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            
            // Update cart display elements (with null checks)
            const cartTotalElement = document.getElementById('cart-total');
            const displayTotalElement = document.getElementById('display-total');
            const cartCountElement = document.getElementById('cart-count');
            
            if (cartTotalElement) cartTotalElement.textContent = cartTotal.toFixed(2);
            if (displayTotalElement) displayTotalElement.textContent = cartTotal.toFixed(2);
            if (cartCountElement) cartCountElement.textContent = totalItems;

            const cartItems = document.getElementById('cart-items');
            if (cartItems) {
                if (cart.length === 0) {
                    cartItems.innerHTML = '<div class="empty-cart">Your cart is empty</div>';
                } else {
                    cartItems.innerHTML = cart.map((item) => `
                        <div class="cart-item">
                            <div class="cart-item-info">
                                <div class="cart-item-name">${item.name}</div>
                                <div class="cart-item-price">$${item.price} each</div>
                            </div>
                            <div class="cart-item-controls">
                                <div class="quantity-controls">
                                    <button onclick="updateQuantity('${item.id}', -1)" class="quantity-btn minus">‚àí</button>
                                    <span class="quantity">${item.quantity}</span>
                                    <button onclick="updateQuantity('${item.id}', 1)" class="quantity-btn plus">+</button>
                                </div>
                                <div class="cart-item-total">$${(item.price * item.quantity).toFixed(2)}</div>
                                <button onclick="removeFromCart('${item.id}')" class="remove-btn">√ó</button>
                            </div>
                        </div>
                    `).join('');
                }
            }
        }

        // Start Shopping Chat with auto-scroll
        function startChatShopping() {
            if (cart.length === 0) {
                addMessage('assistant', '**Welcome! Your cart is empty.**\n\n**I can help you shop!** Try asking:\n‚Ä¢ *"What T-shirts do you have?"*\n‚Ä¢ *"Do you have Classic Cotton Tees?"*\n‚Ä¢ *"Add 2 Premium Polo Shirts to my cart"*\n‚Ä¢ *"Show me your products"*\n\n**What are you looking for today?**');
            } else {
                addMessage('assistant', `**Ready to shop or checkout!**\n\n**Current Cart:**
${cart.map(item => `‚Ä¢ ${item.name} (Qty: ${item.quantity}) - $${(item.price * item.quantity).toFixed(2)}`).join('\n')}\n\n**Total: $${cartTotal.toFixed(2)}**\n\n**I can help you:**\n‚Ä¢ *"Add more items to cart"*\n‚Ä¢ *"What other products do you have?"*\n‚Ä¢ *"Checkout with your-email@example.com"*`);
            }
            
            // Auto-scroll to Skipify Assistant chat window
            setTimeout(() => {
                const skipifyAssistant = document.querySelector('.skipify-assistant-section');
                if (skipifyAssistant) {
                    skipifyAssistant.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                    
                    // Focus on the chat input for better UX
                    setTimeout(() => {
                        const chatInput = document.querySelector('#user-input');
                        if (chatInput) {
                            chatInput.focus();
                        }
                    }, 500);
                }
            }, 100);
        }

        // Skipify SDK Integration (fixed to match working test page)
        function waitForSDK() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 100; // 10 seconds max wait

                const checkSDK = () => {
                    attempts++;
                    
                    if (attempts === 1 || attempts % 10 === 0) {
                        console.log(`üîç Checking for Skipify SDK... attempt ${attempts}/${maxAttempts}`);
                    }
                    
                    // ‚úÖ FIXED: Check for window.skipify (lowercase) like working test page
                    if (window.skipify) {
                        console.log('‚úÖ Skipify SDK found and loaded successfully');
                        console.log('üîß SDK constructor available:', window.skipify);
                        resolve(window.skipify);
                    } else if (attempts >= maxAttempts) {
                        console.error('‚ùå Skipify SDK failed to load after 10 seconds');
                        
                        // Additional debugging
                        console.log('üîç Checking different possible global names:');
                        console.log('- window.skipify:', typeof window.skipify);
                        console.log('- window.Skipify:', typeof window.Skipify);
                        console.log('- typeof Skipify:', typeof Skipify);
                        
                        const scriptTags = document.querySelectorAll('script[src*="skipify"]');
                        console.log('üîç Skipify script tags found:', scriptTags.length);
                        scriptTags.forEach((script, index) => {
                            console.log(`Script ${index + 1}:`, script.src, 'loaded:', script.readyState);
                        });
                        
                        reject(new Error('Skipify SDK failed to load - check network connection and console for details'));
                    } else {
                        setTimeout(checkSDK, 100);
                    }
                };
                
                // Start checking immediately
                checkSDK();
            });
        }

        async function initializeSkipifySDK() {
            try {
                console.log('üöÄ Starting Skipify SDK initialization for T-shirt store...');
                const SkipifyConstructor = await waitForSDK();
                
                // ‚úÖ FIXED: Use returned constructor and 'stage' environment like working test page
                skipifySDK = new SkipifyConstructor({
                    merchantId: '1bdc8b60-6dd4-4126-88e1-c9e5b570f1a0',
                    environment: 'stage'
                });

                console.log('üéØ Skipify SDK initialized for T-shirt store:', skipifySDK);
                console.log('üîß SDK methods available:', Object.keys(skipifySDK));
                
                // ‚úÖ FIXED: Wait for SDK to be fully ready before testing
                try {
                    // Add small delay to ensure SDK is fully initialized
                    await new Promise(resolve => setTimeout(resolve, 500));
                    const deviceId = await skipifySDK.deviceId();
                    console.log('üì± Device ID test successful:', deviceId);
                    addMessage('system', 'Skipify payment system ready and tested');
                } catch (deviceError) {
                    console.warn('‚ö†Ô∏è Device ID test failed, but SDK may still work:', deviceError);
                    addMessage('system', 'Skipify payment system loaded');
                }
            } catch (error) {
                console.error('‚ùå Failed to initialize Skipify SDK:', error);
                addMessage('system', `‚ùå Payment system initialization failed: ${error.message}`);
                
                // Provide fallback message
                addMessage('assistant', `‚ö†Ô∏è **Payment system not available**
                
**The Skipify SDK failed to load.** This might be due to:
‚Ä¢ Network connectivity issues
‚Ä¢ Browser blocking the SDK script
‚Ä¢ Server configuration problems

**To fix this:**
1. Check your internet connection
2. Refresh the page
3. Try a different browser
4. Contact support if the issue persists`);
            }
        }

        // Shopping Assistant Functions
        function searchProducts(query) {
            const lowerQuery = query.toLowerCase();
            return PRODUCTS.filter(product => 
                product.name.toLowerCase().includes(lowerQuery) ||
                product.description.toLowerCase().includes(lowerQuery) ||
                product.id.toLowerCase().includes(lowerQuery)
            );
        }

        function parseQuantity(text) {
            const numberWords = {
                'one': 1, 'two': 2, 'three': 3, 'four': 4, 'five': 5,
                'six': 6, 'seven': 7, 'eight': 8, 'nine': 9, 'ten': 10
            };
            
            // Look for numbers first
            const numberMatch = text.match(/\b(\d+)\b/);
            if (numberMatch) {
                return parseInt(numberMatch[1]);
            }
            
            // Look for word numbers
            for (const [word, num] of Object.entries(numberWords)) {
                if (text.toLowerCase().includes(word)) {
                    return num;
                }
            }
            
            return 1; // Default quantity
        }

        function addToCartViaChat(productId, quantity = 1) {
            const product = PRODUCTS.find(p => p.id === productId);
            if (!product) return false;

            // Check if product already exists in cart
            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                cart.push({ ...product, quantity: quantity });
            }
            
            updateCartDisplay();
            return true;
        }

        // Chat Functions
        function addMessage(type, content) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            if (type === 'assistant' || type === 'system') {
                messageDiv.innerHTML = content.replace(/\n/g, '<br>');
            } else {
                messageDiv.textContent = content;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Add component message to chat with embedded container
        function addComponentMessage(type, content, componentType, componentId) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type} component-message`;
            
            // Format content with line breaks
            const formattedContent = content.replace(/\n/g, '<br>');
            
            // Create component container
            const componentContainer = `
                <div class="embedded-component-container" id="${componentId}">
                    <div class="component-loading">
                        üîÑ Loading ${componentType}...
                    </div>
                </div>
            `;
            
            messageDiv.innerHTML = formattedContent + componentContainer;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            return document.getElementById(componentId);
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            addMessage('user', message);
            input.value = '';

            // Enhanced shopping and e-commerce context handling
            const lowerMessage = message.toLowerCase();
            
            // Handle shopping inquiries first (before checkout)
            const productInquiryTriggers = [
                'do you have',
                'what do you have',
                'show me',
                'what products',
                'what t-shirts',
                'what shirts',
                'what items',
                'available',
                'sell',
                'carry',
                'stock'
            ];
            
            const addToCartTriggers = [
                'add',
                'put in cart',
                'add to cart',
                'i want',
                'i need',
                'get me'
            ];
            
            const isProductInquiry = productInquiryTriggers.some(trigger => lowerMessage.includes(trigger));
            const isAddToCartRequest = addToCartTriggers.some(trigger => lowerMessage.includes(trigger));
            
            // Handle shopping requests
            if (isProductInquiry && !lowerMessage.includes('checkout') && !lowerMessage.includes('@')) {
                // Extract product search terms
                let searchTerm = '';
                if (lowerMessage.includes('classic')) searchTerm = 'classic';
                else if (lowerMessage.includes('polo')) searchTerm = 'polo';
                else if (lowerMessage.includes('vintage') || lowerMessage.includes('graphic')) searchTerm = 'vintage';
                else if (lowerMessage.includes('cotton')) searchTerm = 'cotton';
                else if (lowerMessage.includes('premium')) searchTerm = 'premium';
                
                if (searchTerm) {
                    const foundProducts = searchProducts(searchTerm);
                    if (foundProducts.length > 0) {
                        const productList = foundProducts.map(p => 
                            `‚Ä¢ **${p.name}** - $${p.price} (${p.description})`
                        ).join('\n');
                        
                        addMessage('assistant', `‚úÖ **Yes, we have that!**\n\n${productList}\n\n**Would you like to add any to your cart?**\n\nJust say: *"Add 2 ${foundProducts[0].name}s to my cart"*`);
                    } else {
                        addMessage('assistant', '**Sorry, I didn\'t find that specific item.**\n\n**Here\'s what we have:**\n' + 
                            PRODUCTS.map(p => `‚Ä¢ **${p.name}** - $${p.price}`).join('\n') + 
                            '\n\n**Which one interests you?**');
                    }
                } else {
                    // General product listing
                    addMessage('assistant', '**Here\'s our T-Shirt collection:**\n\n' + 
                        PRODUCTS.map(p => `‚Ä¢ **${p.name}** - $${p.price}\n  ${p.description}`).join('\n\n') + 
                        '\n\n**Which one would you like to add to your cart?**');
                }
                return;
            }
            
            if (isAddToCartRequest && !lowerMessage.includes('checkout') && !lowerMessage.includes('@')) {
                // Parse quantity and product
                const quantity = parseQuantity(message);
                let productFound = null;
                
                // Look for specific products
                for (const product of PRODUCTS) {
                    const productKeywords = [
                        product.name.toLowerCase(),
                        product.id.toLowerCase(),
                        ...product.name.toLowerCase().split(' ')
                    ];
                    
                    if (productKeywords.some(keyword => lowerMessage.includes(keyword))) {
                        productFound = product;
                        break;
                    }
                }
                
                if (productFound) {
                    const success = addToCartViaChat(productFound.id, quantity);
                    if (success) {
                        addMessage('assistant', `‚úÖ **Added to cart!**\n\n‚Ä¢ ${quantity}x ${productFound.name} - $${(productFound.price * quantity).toFixed(2)}\n\n**Cart Total: $${cartTotal.toFixed(2)}**\n\n**What else can I help you find, or ready to checkout?**`);
                    } else {
                        addMessage('assistant', '‚ùå **Sorry, there was an error adding that item to your cart.**');
                    }
                } else {
                    addMessage('assistant', '**I\'d love to help you add something to your cart!**\n\n**Please specify which item:**\n' + 
                        PRODUCTS.map(p => `‚Ä¢ ${p.name}`).join('\n') + 
                        '\n\nExample: *"Add 2 Classic Cotton Tees to my cart"*');
                }
                return;
            }
            
            // Define comprehensive trigger patterns for checkout/order processing
            const checkoutTriggers = [
                'checkout',
                'buy',
                'purchase', 
                'process my order',
                'process order',
                'pay with',
                'do i have any cards',
                'cards available',
                'payment methods',
                'complete order',
                'finalize purchase',
                'skipify account'
            ];
            
            const isCheckoutRequest = checkoutTriggers.some(trigger => lowerMessage.includes(trigger));
            
            if (isCheckoutRequest) {
                if (cart.length === 0) {
                    addMessage('assistant', '**Cart is empty!** Please add some T-shirts to your cart first.');
                    return;
                }
                
                // Extract email with improved pattern matching
                const emailMatch = message.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/);
                if (emailMatch) {
                    const email = emailMatch[0];
                    addMessage('assistant', `**Starting checkout process...**

**Order Summary:**
${cart.map(item => `‚Ä¢ ${item.name} (Qty: ${item.quantity}) - $${(item.price * item.quantity).toFixed(2)}`).join('\n')}

**Total: $${cartTotal.toFixed(2)}**

Looking up your Skipify account: ${email}`);
                    
                    // Start Skipify lookup process
                    await executeEcommerceCheckout(email);
                    return;
                } else {
                    // Check if they mentioned email but didn't provide one
                    if (lowerMessage.includes('email') || lowerMessage.includes('my email')) {
                        addMessage('assistant', '**Please provide your email address for checkout.**\n\nExample: *"Checkout with your-email@example.com"*');
                        return;
                    } else {
                        addMessage('assistant', '**Please provide your email address for checkout.**\n\nExample: *"Checkout with your-email@example.com"*');
                    return;
                    }
                }
            }

            // Regular chat handling
            if (!currentSession) {
                addMessage('assistant', '**No chat session active.** Please click "New Chat Session" to start.');
                return;
            }

            try {
                // Additional pattern matching for common queries before sending to backend
                if (lowerMessage.includes('help') || lowerMessage === 'hi' || lowerMessage === 'hello') {
                    addMessage('assistant', `**Welcome! I can help you shop and checkout with Skipify.**

**Shopping Commands:**
‚Ä¢ *"What T-shirts do you have?"* - See all products
‚Ä¢ *"Do you have Classic Cotton Tees?"* - Search for specific items
‚Ä¢ *"Add 2 Premium Polo Shirts to my cart"* - Add items to cart

**Checkout Commands:**
‚Ä¢ *"Checkout with your-email@example.com"* - Start checkout
‚Ä¢ *"Process my order with my email: your-email@example.com"* - Begin payment

**I can help you:**
‚Ä¢ Browse our T-shirt collection
‚Ä¢ Add items to your cart
‚Ä¢ Process secure payments with Skipify
‚Ä¢ Find your Skipify account and payment methods

**What would you like to do today?**`);
                    return;
                }

                const response = await fetch(`${window.APP_CONFIG.BACKEND_URL}/api/chat/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: currentSession,
                        message: message
                    })
                });

                const data = await response.json();
                
                // Intercept generic responses and make them more helpful
                if (data.content && data.content.toLowerCase().includes("i'd be happy to help")) {
                    addMessage('assistant', '**Please provide your email address for checkout.**\n\nExample: *"Checkout with your-email@example.com"*');
                    return;
                }
                
                addMessage('assistant', data.content);

                // Execute Skipify operations if metadata present
                if (data.metadata && data.metadata.executeSDK) {
                    await executeSkipifyAction(data.metadata.skipifyAction, data.metadata.parameters);
                }
            } catch (error) {
                console.error('Chat error:', error);
                addMessage('assistant', '**Chat service error.** Please try again.');
            }
        }

        // E-commerce Checkout Flow
        async function executeEcommerceCheckout(email) {
            try {
                // Check if SDK is loaded
                if (!skipifySDK) {
                    addMessage('assistant', `**Skipify SDK not available**
                    
**The payment system is not ready.** Please:
1. **Refresh the page** and wait for the SDK to load
2. **Check the browser console** for any errors
3. **Try again** in a few moments

**If the problem persists:**
‚Ä¢ Check your internet connection
‚Ä¢ Try a different browser
‚Ä¢ Contact support for assistance`);
                    return;
                }

                // Step 1: Lookup
                addMessage('system', 'Step 1: Looking up Skipify account...');
                const lookupResult = await Promise.race([
                    skipifySDK.lookup({ email: email }),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('Lookup timed out after 5 seconds')), 5000))
                ]);
                
                if (lookupResult.error) {
                    addMessage('assistant', `**Checkout failed:** ${lookupResult.error.message}\n\nThis email may not be registered with Skipify.`);
                    return;
                }

                lookupResults = lookupResult;
                storedChallengeId = lookupResult.challengeId;
                
                // FIXED: Check payment methods using correct flags structure
                const directFlags = lookupResult.flags?.potentialPaymentMethods;
                const nestedFlags = lookupResult.lookupData?.flags?.potentialPaymentMethods;
                const hasPaymentMethods = directFlags || nestedFlags || false;

                // Payment method detection working correctly - debug code removed

                addMessage('assistant', `‚úÖ **Skipify account found!**

üë§ **Account Details:**
‚Ä¢ Email: ${email}
‚Ä¢ Payment Methods: ${hasPaymentMethods ? '‚úÖ Available' : '‚ùå None found'}

üîê **Authentication required - please follow the prompts to authenticate on the website**`);

                // Step 2: Authentication using inline approach
                addMessage('system', 'üîê Step 2: Starting authentication...');
                
                let responseText = `‚úÖ **Skipify account found!**

üë§ **Account Details:**
‚Ä¢ Email: ${email}
‚Ä¢ Payment Methods: ${hasPaymentMethods ? '‚úÖ Available' : '‚ùå None found'}

üîê **Starting authentication...**`;
                
                // Create inline authentication component message
                const authContainerId = `ecommerce-auth-${Date.now()}`;
                const authContainer = addComponentMessage('assistant', responseText, 'Authentication', authContainerId);
                authContainer.className += ' auth-component inline-component';
                authContainer.style.maxHeight = '350px';
                authContainer.style.height = '320px';
                authContainer.style.overflow = 'auto';
                
                // Store container for later replacement
                window.currentAuthContainer = authContainer;
                window.currentAuthContainerId = authContainerId;
                
                // Use the inline authentication function that works
                setTimeout(() => {
                    startInlineAuthentication(lookupResults, authContainer);
                }, 500);

            } catch (error) {
                console.error('E-commerce checkout error:', error);
                addMessage('assistant', `‚ùå **Checkout error:** ${error.message}\n\nPlease try again or contact support.`);
            }
        }

        // Skipify Payment Submission (via backend to avoid CORS)
        async function submitSkipifyPayment(paymentId, sessionId, amount, merchantReference = null) {
            try {
                const paymentData = {
                    paymentId: paymentId,
                    sessionId: sessionId,
                    amount: amount, // Amount is already in cents when passed to this function
                    merchantReference: merchantReference || `order_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    enableRecurring: false
                };

                console.log('üöÄ Submitting payment via backend:', paymentData);
                addMessage('system', 'üí≥ Submitting payment to Skipify...');

                // Call our backend instead of Skipify directly to avoid CORS
                const response = await fetch(`${window.APP_CONFIG.BACKEND_URL}/api/skipify/payments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(paymentData)
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    console.log('‚úÖ Payment submission successful:', result);
                    
                    // Store cart items before clearing (handle both cart and non-cart scenarios)
                    const totalAmount = cart.length > 0 ? cart.reduce((sum, item) => sum + item.price, 0) : (amount / 100);
                    const purchasedItems = cart.length > 0 ? [...cart] : [
                        { emoji: 'üéØ', name: 'Test Purchase', price: totalAmount }
                    ];
                    
                    // Display receipt with full order details
                    displayReceipt(purchasedItems, result, totalAmount);
                    
                    // Show success message in chat - fix transaction ID access
                    const transactionId = result.transactionId || result.data?.transactionId || 'Generated';
                    addMessage('assistant', `üéâ **Payment Successful!**

üí≥ **Transaction Completed:**
‚Ä¢ Amount: $${totalAmount.toFixed(2)}
‚Ä¢ Transaction ID: ${transactionId.substring(0, 12)}...
‚Ä¢ Status: ${result.status || result.data?.status || 'Completed'}

‚úÖ **Your order receipt is displayed on the left. Thank you for your purchase!**`);

                    // Clear the cart after successful payment
                    cart = [];
                    updateCartDisplay();
                    
                    return result;
                } else {
                    console.error('‚ùå Payment submission failed:', result);
                    addMessage('assistant', `‚ùå **Payment Failed**

**Error:** ${result.error || 'Unknown error occurred'}

üí° **Please try again or contact support.**`);
                    throw new Error(result.error || 'Payment submission failed');
                }

            } catch (error) {
                console.error('üí• Payment submission error:', error);
                addMessage('assistant', `‚ùå **Payment Error**

**Error:** ${error.message}

üí° **Please try again or contact support if the problem persists.**`);
                throw error;
            }
        }

        // E-commerce Carousel Display (called after authentication succeeds)
        async function showEcommerceCarousel(email, authData) {
            try {
                addMessage('system', 'üí≥ Step 3: Loading payment options...');
                
                // Use integrated carousel container
                const carouselContainer = document.getElementById('carousel-container-placeholder');
                if (carouselContainer) {
                    carouselContainer.classList.add('active');
                    carouselContainer.innerHTML = '<h4 style="margin-bottom: 15px; color: #2c3e50;">üí≥ Select Payment Method</h4><div id="ecommerce-carousel-content" style="min-height: 250px;"></div>';
                    addMessage('system', 'üí≥ Payment carousel will appear in the integrated assistant section');
                    console.log('üí≥ E-commerce carousel container prepared:', carouselContainer);
                }

                // ‚úÖ ENHANCED: Show confirmation step before payment
                const carouselOptions = {
                    onSelect: async (result) => {
                        console.log('E-commerce carousel payment selected:', result);
                        console.log('üîç Payment result properties:', {
                            networkType: result.metadata?.networkType || result.networkType,
                            cardType: result.cardType,
                            lastFour: result.metadata?.lastFour || result.lastFour,
                            cardEnding: result.cardEnding,
                            metadata: result.metadata,
                            allKeys: Object.keys(result)
                        });
                        
                        // Store payment details for confirmation
                        window.selectedPaymentDetails = {
                            paymentId: result.paymentId,
                            sessionId: result.sessionId,
                            cardType: result.metadata?.networkType || result.networkType || result.cardType || 'Card',
                            cardEnding: result.metadata?.lastFour || result.lastFour || result.cardEnding || 'XXXX',
                            amount: cartTotal
                        };
                        
                        // Show payment confirmation instead of immediately processing
                        showPaymentConfirmation(window.selectedPaymentDetails, cartTotal);
                    },
                    onError: (error) => {
                        console.error('E-commerce carousel error:', error);
                        addMessage('assistant', `‚ùå **Checkout error:** ${error.message || error}\n\nPlease try again or contact support.`);
                    },
                    amount: Math.round(cartTotal * 100), // Amount in cents
                    config: {
                        theme: "light",
                        fontFamily: "default",
                        fontSize: "medium"
                    }
                };

                // Use exact API from working test page: carousel(authenticationResult, options).render(container)
                console.log('Calling skipifySDK.carousel with authData and options...');
                const carouselComponent = skipifySDK.carousel(authData, carouselOptions);
                console.log('Carousel component created:', carouselComponent);
                
                // Render the carousel
                console.log('Rendering carousel to container...');
                carouselComponent.render(document.getElementById('ecommerce-carousel-content'));

                addMessage('assistant', `üéâ **Checkout Ready!**

üí≥ **Payment carousel loaded** - **click on your preferred payment method** above to complete your $${cartTotal.toFixed(2)} purchase.

üõçÔ∏è **Your T-shirt order:**
${cart.map(item => `‚Ä¢ ${item.name} (Qty: ${item.quantity}) - $${(item.price * item.quantity).toFixed(2)}`).join('\n')}

**Total: $${cartTotal.toFixed(2)}**

üí° **Next step:** Select a payment method from the carousel above to finalize your purchase!`);

            } catch (error) {
                console.error('E-commerce carousel error:', error);
                addMessage('assistant', `‚ùå **Carousel error:** ${error.message}\n\nPlease try again or contact support.`);
            }
        }

        // Skipify Action Execution (same as test page)
        async function executeSkipifyAction(action, parameters) {
            addMessage('system', `üöÄ Executing ${action} operation via frontend SDK...`);

            switch (action) {
                case 'lookup':
                    await executeSDKLookup(parameters);
                    break;
                case 'auth':
                    await executeSDKAuth(parameters);
                    break;
                case 'carousel':
                    await executeSDKCarousel(parameters);
                    break;
                case 'device_id':
                    await executeSDKDeviceId(parameters);
                    break;
                case 'card_selection':
                    await executeSDKCardSelection(parameters);
                    break;
                default:
                    addMessage('assistant', `‚ùå Unknown Skipify action: ${action}`);
            }
        }

        // Execute SDK functions (enhanced versions for T-shirt store)
        async function executeSDKLookup(parameters) {
            const { email, phone } = parameters;
            
            if (!skipifySDK) {
                addMessage('assistant', `‚ùå **Skipify SDK not available**
                
**The payment system is not ready.** Please refresh the page and wait for the SDK to load, then try again.`);
                return;
            }

            try {
                const lookupParams = {};
                if (email) lookupParams.email = email;
                if (phone) lookupParams.phone = phone;

                const result = await Promise.race([
                    skipifySDK.lookup(lookupParams),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('Lookup timed out after 3 seconds')), 3000))
                ]);

                lookupResults = result;
                storedChallengeId = result.challengeId;

                // Check payment methods in multiple possible locations
                const directFlags = result.flags?.potentialPaymentMethods;
                const nestedFlags = result.lookupData?.flags?.potentialPaymentMethods;
                const hasPaymentMethods = directFlags || nestedFlags || false;
                const contact = email || phone;

                // Debug message to see what's happening (UPDATED VERSION)
                addMessage('system', `üîç **UPDATED DEBUG (${new Date().toLocaleTimeString()}):**
‚Ä¢ result.flags: ${JSON.stringify(result.flags)}
‚Ä¢ result.lookupData?.flags: ${JSON.stringify(result.lookupData?.flags)}
‚Ä¢ directFlags: ${directFlags}
‚Ä¢ nestedFlags: ${nestedFlags}
‚Ä¢ hasPaymentMethods: ${hasPaymentMethods}`);

                if (hasPaymentMethods && result.challengeId) {
                let responseText = `‚úÖ **Skipify account found!**

üë§ **Account Details:**
‚Ä¢ Email: ${contact}
‚Ä¢ Payment Methods: ${hasPaymentMethods ? '‚úÖ Available' : '‚ùå None found'}

üîê **Starting authentication...**`;
                    
                    // Create authentication component message with increased height
                    const authContainerId = `chat-auth-${Date.now()}`;
                    const authContainer = addComponentMessage('assistant', responseText, 'Authentication', authContainerId);
                    authContainer.className += ' auth-component inline-component';
                    authContainer.style.maxHeight = '350px';
                    authContainer.style.height = '320px';
                    authContainer.style.overflow = 'auto';
                    
                    // Store container ID for later replacement
                    window.currentAuthContainer = authContainer;
                    window.currentAuthContainerId = authContainerId;
                    
                    // Start authentication immediately
                    setTimeout(() => {
                        startInlineAuthentication(result, authContainer);
                    }, 500);
                } else {
                    let responseText = `‚úÖ **Skipify account found!**

üë§ **Account Details:**
‚Ä¢ Email: ${contact}
‚Ä¢ Payment Methods: ${hasPaymentMethods ? '‚úÖ Available' : '‚ùå None found'}

‚ùå **No payment methods found.** This account may not have any cards on file.`;

                addMessage('assistant', responseText);
                }

            } catch (error) {
                console.error('SDK lookup error:', error);
                addMessage('assistant', `‚ùå **Lookup failed:** ${error.message}\n\nüí° This might be due to network issues or the email not being in the Skipify network.`);
            }
        }

        async function executeSDKAuth(parameters) {
            const { challengeId, phone } = parameters;
            
            const finalChallengeId = challengeId || storedChallengeId;
            
            if (!finalChallengeId) {
                addMessage('assistant', '‚ùå **Challenge ID required for authentication.** Please perform a lookup first to get a challenge ID, then try authentication again.');
                return;
            }
            
            if (!challengeId && storedChallengeId) {
                console.log('üîë Using stored challenge ID from previous lookup:', storedChallengeId);
                addMessage('system', 'üîë Using challenge ID from previous lookup automatically');
            }

            if (!skipifySDK) {
                addMessage('assistant', '‚ùå **Skipify SDK not loaded** - cannot perform authentication.');
                return;
            }

            addMessage('assistant', 'üîê **Starting authentication process...** The authentication component will appear in the components section below.');

            try {
                if (!lookupResults) {
                    addMessage('assistant', '‚ùå **Lookup results required for authentication.** Please perform a lookup first to get the full context needed for authentication.');
                    return;
                }

                const authParams = { ...lookupResults };
                authParams.challengeId = finalChallengeId;

                if (phone) {
                    authParams.phone = phone;
                }

                // ‚úÖ FIXED: Use proper authentication call with callbacks like working test page
                const result = await skipifySDK.authentication(authParams, {
                    onSuccess: (data) => {
                        console.log('Authentication success:', data);
                        window.authenticationResult = data;
                        
                        let responseText = `‚úÖ **Authentication completed successfully!**\n\n`;
                        responseText += `**Authentication Results:**\n`;
                        responseText += `‚Ä¢ Shopper ID: ${data.shopperId || 'Retrieved'}\n`;
                        responseText += `‚Ä¢ Session ID: ${data.sessionId || 'Active'}\n\n`;
                        responseText += `üéØ **Next Step:** You can now show payment options by saying:\n*"Show payment carousel for $${cartTotal.toFixed(2)}"*`;
                        
                        addMessage('assistant', responseText);
                    },
                    onError: (error) => {
                        console.error('Authentication error:', error);
                        addMessage('assistant', `‚ùå **Authentication failed:** ${error.message || error}\n\nüí° Please try again or check the challenge ID.`);
                    },
                    onCancel: () => {
                        console.log('Authentication cancelled');
                        addMessage('assistant', '‚ö†Ô∏è **Authentication cancelled** by user. Please try again when ready.');
                    }
                });

                // Show auth container (now integrated in chat)
                const container = document.getElementById('skipify-auth-container');
                if (container) {
                    container.classList.add('active');
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">üîÑ Loading authentication component...</div>';
                    addMessage('system', 'üì± Authentication component loading in the integrated interface...');
                    console.log('üì± Authentication container prepared:', container);
                }
                
                // Add delay to ensure container is ready
                setTimeout(() => {
                // Render the authentication component if result has render function
                if (result && typeof result.render === 'function') {
                        console.log('üé® Calling render function to display authentication component in chat');
                    
                    try {
                        result.render(container);
                            console.log('‚úÖ Authentication component rendered successfully in integrated chat');
                            addMessage('system', '‚úÖ Authentication component loaded successfully');
                    } catch (renderError) {
                        console.error('Error rendering auth component:', renderError);
                        addMessage('assistant', `‚ùå **Error displaying authentication component:** ${renderError.message}`);
                            
                            // Show fallback message
                            if (container) {
                                container.innerHTML = `
                                    <div style="text-align: center; padding: 20px;">
                                        <div style="color: #f44336; font-size: 18px; margin-bottom: 10px;">‚ùå Authentication Component Error</div>
                                        <div style="color: #666; font-size: 14px;">${renderError.message}</div>
                                        <div style="margin-top: 15px;">
                                            <button onclick="retrySDKInitialization()" style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                                                üîß Retry Authentication
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }
                        }
                    } else {
                        console.warn('‚ö†Ô∏è Authentication result does not have render function:', result);
                        addMessage('assistant', '‚ö†Ô∏è **Authentication component not available.** Please try refreshing the page.');
                    }
                }, 500);

            } catch (error) {
                console.error('SDK authentication error:', error);
                addMessage('assistant', `‚ùå **Authentication failed:** ${error.message}\n\nüí° Please try the authentication process again.`);
            }
        }

        // Start inline authentication within chat message using direct rendering approach
        async function startInlineAuthentication(lookupResult, container) {
            try {
                console.log('üîê Starting inline authentication in chat message...');
                console.log('üîç Target container:', container);
                console.log('üîç Container ID:', container.id);
                
                // Set up inline container styling - increased height for authentication
                container.classList.add('inline-component');
                container.style.maxHeight = '350px';
                container.style.height = '320px';
                container.style.overflow = 'auto';
                container.style.display = 'block';
                container.style.position = 'relative';
                container.style.zIndex = '1';
                
                // Show loading state
                container.innerHTML = '<div class="component-loading" style="text-align: center; padding: 20px; color: #666;">üîÑ Loading authentication...</div>';
                
                // Force DOM update and wait for container to be ready
                await new Promise(resolve => {
                    requestAnimationFrame(() => {
                        requestAnimationFrame(resolve);
                    });
                });
                
                // Verify container is ready
                if (!document.contains(container)) {
                    throw new Error('Container not properly attached to DOM');
                }
                
                console.log('‚úÖ Container ready for direct SDK rendering');
                
                const authParams = { ...lookupResult };
                
                // Try direct rendering to inline container first
                const result = await skipifySDK.authentication(authParams, {
                    onSuccess: (data) => {
                        console.log('üéâ Inline authentication success:', data);
                        window.authenticationResult = data;
                        
                        // Show success in inline container
                        container.innerHTML = `
                            <div style="text-align: center; padding: 15px;">
                                <div style="font-size: 32px; margin-bottom: 10px;">‚úÖ</div>
                                <div style="font-size: 16px; font-weight: bold; color: #4caf50; margin-bottom: 8px;">
                                    Authentication Successful!
                                </div>
                                <div style="color: #666; font-size: 12px;">
                                    Loading payment options...
                                </div>
                            </div>
                        `;
                        
                        // Replace with payment carousel after brief success display
                        setTimeout(() => {
                            replaceWithPaymentCarousel(container, cartTotal);
                        }, 1500);
                    },
                    onError: (error) => {
                        console.error('‚ùå Direct authentication error:', error);
                        
                        // Better error object handling
                        let errorMessage = 'Authentication failed';
                        if (error && typeof error === 'object') {
                            errorMessage = error.message || error.error?.message || JSON.stringify(error);
                        } else if (typeof error === 'string') {
                            errorMessage = error;
                        }
                        
                        container.innerHTML = `
                            <div style="text-align: center; padding: 15px;">
                                <div style="font-size: 32px; margin-bottom: 10px;">‚ùå</div>
                                <div style="font-size: 16px; font-weight: bold; color: #f44336; margin-bottom: 8px;">
                                    Authentication Failed
                                </div>
                                <div style="color: #666; font-size: 12px;">
                                    ${errorMessage}
                                </div>
                                <div style="margin-top: 10px;">
                                    <button onclick="retrySDKInitialization()" style="background: #3498db; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">
                                        üîß Retry
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        addMessage('assistant', `‚ùå **Authentication failed:** ${errorMessage}\n\nüí° Please try again or check your credentials.`);
                    },
                    onCancel: () => {
                        console.log('‚ö†Ô∏è Inline authentication cancelled');
                        
                        container.innerHTML = `
                            <div style="text-align: center; padding: 15px;">
                                <div style="font-size: 32px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                                <div style="font-size: 16px; font-weight: bold; color: #ff9800; margin-bottom: 8px;">
                                    Authentication Cancelled
                                </div>
                                <div style="color: #666; font-size: 12px;">
                                    You can try again anytime
                                </div>
                            </div>
                        `;
                        
                        addMessage('assistant', '‚ö†Ô∏è **Authentication cancelled.** Let me know when you\'re ready to try again!');
                    }
                });

                console.log('üéØ Authentication SDK call completed, result:', result);
                
                // Try to render directly to inline container first
                setTimeout(() => {
                    if (result && typeof result.render === 'function') {
                        console.log('üé® Attempting direct render to inline container');
                        
                        try {
                            // Clear loading state before rendering
                            container.innerHTML = '';
                            
                            // Try direct render first
                            result.render(container);
                            console.log('‚úÖ Direct authentication component render successful');
                            
                            // Apply styling to any iframes
                            setTimeout(() => {
                                const iframes = container.querySelectorAll('iframe');
                                iframes.forEach(iframe => {
                                    iframe.style.width = '100%';
                                    iframe.style.height = '300px';
                                    iframe.style.maxHeight = '300px';
                                    iframe.style.border = 'none';
                                    iframe.style.borderRadius = '4px';
                                });
                                console.log('‚úÖ Applied styling to authentication iframes');
                            }, 500);
                            
                        } catch (directRenderError) {
                            console.warn('‚ö†Ô∏è Direct render failed, trying fallback approach:', directRenderError);
                            
                            // Fallback: use temp container approach
                            const tempId = `temp-auth-fallback-${Date.now()}`;
                            const tempContainer = document.createElement('div');
                            tempContainer.id = tempId;
                            tempContainer.style.position = 'absolute';
                            tempContainer.style.top = '-10000px';
                            tempContainer.style.left = '-10000px';
                            tempContainer.style.width = '400px';
                            tempContainer.style.height = '240px';
                            document.body.appendChild(tempContainer);
                            
                            try {
                                result.render(tempContainer);
                                console.log('‚úÖ Fallback temp container render successful');
                                
                                setTimeout(() => {
                                    // Move the entire node instead of copying innerHTML
                                    while (tempContainer.firstChild) {
                                        container.appendChild(tempContainer.firstChild);
                                    }
                                    
                                    // Clean up temp container
                                    if (document.body.contains(tempContainer)) {
                                        document.body.removeChild(tempContainer);
                                    }
                                    
                                    console.log('‚úÖ Authentication component moved to inline container');
                                }, 1000);
                                
                            } catch (fallbackError) {
                                console.error('‚ùå Fallback render also failed:', fallbackError);
                                
                                // Clean up temp container
                                if (document.body.contains(tempContainer)) {
                                    document.body.removeChild(tempContainer);
                                }
                                
                                container.innerHTML = `
                                    <div style="text-align: center; padding: 15px; color: #f44336;">
                                        <div style="font-size: 32px; margin-bottom: 10px;">‚ùå</div>
                                        <div style="font-size: 14px; font-weight: bold;">
                                            Authentication component failed to render
                                        </div>
                                        <div style="font-size: 12px; margin-top: 8px;">
                                            ${fallbackError.message}
                                        </div>
                                        <div style="margin-top: 10px;">
                                            <button onclick="location.reload()" style="background: #3498db; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">
                                                üîÑ Refresh Page
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }
                        }
                    } else {
                        console.warn('‚ö†Ô∏è Authentication result does not have render function:', result);
                        
                        container.innerHTML = `
                            <div style="text-align: center; padding: 15px; color: #f44336;">
                                <div style="font-size: 32px; margin-bottom: 10px;">‚ùå</div>
                                <div style="font-size: 14px; font-weight: bold;">
                                    Authentication component unavailable
                                </div>
                                <div style="font-size: 12px; margin-top: 8px;">
                                    SDK did not return a renderable component
                                </div>
                            </div>
                        `;
                    }
                }, 300); // Reduced delay for faster response

            } catch (error) {
                console.error('‚ùå Failed to start inline authentication:', error);
                
                let errorMessage = error.message || error;
                
                container.innerHTML = `
                    <div style="text-align: center; padding: 15px; color: #f44336;">
                        <div style="font-size: 32px; margin-bottom: 10px;">‚ùå</div>
                        <div style="font-size: 14px; font-weight: bold;">
                            Failed to start authentication
                        </div>
                        <div style="font-size: 12px; margin-top: 8px;">
                            ${errorMessage}
                        </div>
                    </div>
                `;
                
                addMessage('assistant', `‚ùå **Authentication setup failed:** ${errorMessage}\n\nüí° Please try refreshing the page.`);
            }
        }

        // Replace authentication component with payment carousel
        async function replaceWithPaymentCarousel(container, amount) {
            try {
                console.log('üí≥ Replacing authentication with payment carousel...');
                
                // Update container styling for carousel with increased height
                container.classList.remove('auth-component');
                container.classList.add('carousel-component', 'inline-component');
                container.style.maxHeight = '350px';
                container.style.height = '300px';
                container.style.overflow = 'auto';
                
                // Show loading state
                container.innerHTML = '<div class="component-loading">üí≥ Loading payment options...</div>';
                
                const carouselAmount = Math.round(amount * 100); // Convert to cents
                
                // Create carousel options
                const options = {
                    onSelect: async (result) => {
                        console.log('Inline carousel payment selected:', result);
                        
                        // Store payment details for confirmation
                        window.selectedPaymentDetails = {
                            paymentId: result.paymentId,
                            sessionId: result.sessionId,
                            cardType: result.metadata?.networkType || result.networkType || result.cardType || 'Card',
                            cardEnding: result.metadata?.lastFour || result.lastFour || result.cardEnding || 'XXXX',
                            amount: amount,
                            isChat: true,
                            isInline: true
                        };
                        
                        // Replace carousel with confirmation
                        container.innerHTML = `
                            <div style="text-align: center; padding: 15px;">
                                <div style="font-size: 32px; margin-bottom: 10px;">üí≥</div>
                                <div style="font-size: 16px; font-weight: bold; color: #2196f3; margin-bottom: 8px;">
                                    Payment Method Selected
                                </div>
                                <div style="color: #666; font-size: 12px; margin-bottom: 10px;">
                                    ${window.selectedPaymentDetails.cardType} ending in ${window.selectedPaymentDetails.cardEnding}
                                </div>
                                <div style="color: #666; font-size: 12px; margin-bottom: 15px;">
                                    Amount: $${amount.toFixed(2)}
                                </div>
                                <div style="display: flex; gap: 8px; justify-content: center; align-items: center;">
                                    <button id="inline-pay-now-btn" style="
                                        background: linear-gradient(135deg, #28a745, #20c997);
                                        color: white;
                                        border: none;
                                        padding: 10px 20px;
                                        border-radius: 6px;
                                        font-size: 14px;
                                        font-weight: bold;
                                        cursor: pointer;
                                    ">
                                        üí≥ Pay $${amount.toFixed(2)}
                                    </button>
                                    <button id="inline-change-card-btn" style="
                                        background: #17a2b8;
                                        color: white;
                                        border: none;
                                        padding: 10px 16px;
                                        border-radius: 6px;
                                        font-size: 14px;
                                        cursor: pointer;
                                    ">
                                        üîÑ Change Card
                                    </button>
                                    <button onclick="location.reload()" style="
                                        background: #6c757d;
                                        color: white;
                                        border: none;
                                        padding: 10px 16px;
                                        border-radius: 6px;
                                        font-size: 14px;
                                        cursor: pointer;
                                    ">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        // Add event listener to pay button
                        document.getElementById('inline-pay-now-btn').addEventListener('click', async () => {
                            await processInlinePayment(container);
                        });
                        
                        // Add event listener to change card button for inline carousel
                        document.getElementById('inline-change-card-btn').addEventListener('click', async () => {
                            console.log('üîÑ Change card requested in inline carousel, re-rendering...');
                            
                            // Show loading while re-rendering carousel
                            container.innerHTML = '<div class="component-loading" style="text-align: center; padding: 20px; color: #666;">üîÑ Loading payment options...</div>';
                            
                            // Re-render the payment carousel in the same container
                            await new Promise(resolve => {
                                requestAnimationFrame(() => {
                                    requestAnimationFrame(resolve);
                                });
                            });
                            
                            // Clear loading and render carousel
                            container.innerHTML = '';
                            
                            try {
                                const carouselComponent = skipifySDK.carousel(window.authenticationResult, options);
                                carouselComponent.render(container);
                                
                                // Apply styling to carousel iframes
                                setTimeout(() => {
                                    const iframes = container.querySelectorAll('iframe');
                                    iframes.forEach(iframe => {
                                        iframe.style.width = '100%';
                                        iframe.style.height = '280px';
                                        iframe.style.maxHeight = '280px';
                                        iframe.style.border = 'none';
                                        iframe.style.borderRadius = '4px';
                                    });
                                }, 500);
                                
                                console.log('‚úÖ Inline payment carousel re-rendered successfully');
                                addMessage('assistant', 'üîÑ **Payment options reloaded!** Select a different payment method or choose the same one again.');
                                
                            } catch (error) {
                                console.error('‚ùå Failed to re-render inline payment carousel:', error);
                                container.innerHTML = `
                                    <div style="text-align: center; padding: 15px; color: #f44336;">
                                        <div style="font-size: 32px; margin-bottom: 10px;">‚ùå</div>
                                        <div style="font-size: 14px; font-weight: bold;">
                                            Failed to reload payment options
                                        </div>
                                        <div style="font-size: 12px; margin-top: 8px;">
                                            ${error.message}
                                        </div>
                                        <div style="margin-top: 10px;">
                                            <button onclick="location.reload()" style="background: #3498db; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">
                                                üîÑ Refresh Page
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }
                        });
                        
                        addMessage('assistant', '‚úÖ **Payment method selected!** Click "Pay Now" to complete your purchase, or "Change Card" to select a different payment method.');
                    },
                    onError: (error) => {
                        console.error('Inline carousel error:', error);
                        container.innerHTML = `
                            <div style="text-align: center; padding: 15px; color: #f44336;">
                                <div style="font-size: 32px; margin-bottom: 10px;">‚ùå</div>
                                <div style="font-size: 14px; font-weight: bold;">Payment Options Error</div>
                                <div style="font-size: 12px; margin-top: 8px;">${error.message || error}</div>
                            </div>
                        `;
                        addMessage('assistant', `‚ùå **Payment options error:** ${error.message || error}`);
                    },
                    amount: carouselAmount,
                    config: {
                        theme: "light",
                        fontFamily: "default",
                        fontSize: "small",
                        compact: true,
                        height: "140px"
                    }
                };

                // Verify container is ready for carousel rendering
                if (!document.contains(container)) {
                    throw new Error('Container not available for carousel rendering');
                }
                
                // Clear loading state before rendering carousel
                container.innerHTML = '';
                
                // Render the carousel component
                const carouselComponent = skipifySDK.carousel(window.authenticationResult, options);
                console.log('üí≥ Rendering inline carousel component');
                
                if (carouselComponent && typeof carouselComponent.render === 'function') {
                    carouselComponent.render(container);
                    console.log('‚úÖ Carousel component rendered successfully');
                } else {
                    throw new Error('Carousel component does not have render function');
                }

            } catch (error) {
                console.error('‚ùå Failed to create payment carousel:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 15px; color: #f44336;">
                        <div style="font-size: 32px; margin-bottom: 10px;">‚ùå</div>
                        <div style="font-size: 14px; font-weight: bold;">Failed to load payment options</div>
                        <div style="font-size: 12px; margin-top: 8px;">${error.message}</div>
                    </div>
                `;
                addMessage('assistant', `‚ùå **Failed to load payment options:** ${error.message}`);
            }
        }

        // Process payment from inline component
        async function processInlinePayment(container) {
            try {
                console.log('üí≥ Processing inline payment...');
                
                // Show processing state
                container.innerHTML = `
                    <div style="text-align: center; padding: 15px;">
                        <div style="font-size: 32px; margin-bottom: 10px;">‚è≥</div>
                        <div style="font-size: 16px; font-weight: bold; color: #ff9800; margin-bottom: 8px;">
                            Processing Payment...
                        </div>
                        <div style="color: #666; font-size: 12px;">
                            Please wait while we process your payment
                        </div>
                    </div>
                `;
                
                const paymentData = window.selectedPaymentDetails;
                const result = await submitSkipifyPayment(
                    paymentData.paymentId,
                    paymentData.sessionId,
                    Math.round(paymentData.amount * 100) // Convert to cents
                );
                
                // Show success state
                container.innerHTML = `
                    <div style="text-align: center; padding: 15px;">
                        <div style="font-size: 32px; margin-bottom: 10px;">üéâ</div>
                        <div style="font-size: 16px; font-weight: bold; color: #28a745; margin-bottom: 8px;">
                            Payment Successful!
                        </div>
                        <div style="color: #666; font-size: 12px; margin-bottom: 10px;">
                            Transaction ID: ${result.transactionId ? result.transactionId.substring(0, 12) + '...' : 'Generated'}
                        </div>
                        <div style="color: #666; font-size: 12px;">
                            Thank you for your purchase!
                        </div>
                    </div>
                `;
                
                addMessage('assistant', 'üéâ **Payment completed successfully!** Your order has been processed and you should receive a confirmation email shortly.');
                
            } catch (error) {
                console.error('‚ùå Inline payment processing failed:', error);
                
                // Show error state
                container.innerHTML = `
                    <div style="text-align: center; padding: 15px;">
                        <div style="font-size: 32px; margin-bottom: 10px;">‚ùå</div>
                        <div style="font-size: 16px; font-weight: bold; color: #f44336; margin-bottom: 8px;">
                            Payment Failed
                        </div>
                        <div style="color: #666; font-size: 12px; margin-bottom: 10px;">
                            ${error.message}
                        </div>
                        <button onclick="location.reload()" style="
                            background: #3498db;
                            color: white;
                            border: none;
                            padding: 8px 16px;
                            border-radius: 4px;
                            font-size: 12px;
                            cursor: pointer;
                        ">
                            Try Again
                        </button>
                    </div>
                `;
                
                addMessage('assistant', `‚ùå **Payment failed:** ${error.message}\n\nüí° Please try again or contact support.`);
            }
        }

        async function executeSDKCarousel(parameters) {
            const { amount, phone } = parameters;
            
            if (!skipifySDK) {
                addMessage('assistant', '‚ùå **Skipify SDK not loaded** - cannot show payment carousel.');
                return;
            }

            if (!window.authenticationResult) {
                addMessage('assistant', '‚ùå **Authentication required first.** Please run lookup and authentication before carousel.');
                return;
            }

            try {
                const carouselAmount = amount || Math.round(cartTotal * 100); // Use cart total if no amount specified
                
                // Create inline carousel component in chat
                let responseText = `üí≥ **Payment Options Available**

**Amount:** $${(carouselAmount / 100).toFixed(2)}

**Select your preferred payment method below:**`;
                
                const carouselContainerId = `chat-carousel-${Date.now()}`;
                const carouselContainer = addComponentMessage('assistant', responseText, 'Payment Options', carouselContainerId);
                carouselContainer.className += ' carousel-component inline-component';
                carouselContainer.style.maxHeight = '350px';
                carouselContainer.style.height = '300px';
                carouselContainer.style.overflow = 'auto';

                // ‚úÖ ENHANCED: Inline confirmation in same container
                const options = {
                    onSelect: async (result) => {
                        console.log('Inline chat carousel payment selected:', result);
                        
                        // Use cart total if available, otherwise use carousel amount
                        const paymentAmount = cartTotal > 0 ? cartTotal : (carouselAmount / 100);
                        
                        // Store payment details for confirmation
                        window.selectedPaymentDetails = {
                            paymentId: result.paymentId,
                            sessionId: result.sessionId,
                            cardType: result.metadata?.networkType || result.networkType || result.cardType || 'Card',
                            cardEnding: result.metadata?.lastFour || result.lastFour || result.cardEnding || 'XXXX',
                            amount: paymentAmount,
                            isChat: true,
                            isInline: true
                        };
                        
                        // Replace carousel with inline confirmation
                        carouselContainer.innerHTML = `
                            <div style="text-align: center; padding: 15px;">
                                <div style="font-size: 32px; margin-bottom: 10px;">üí≥</div>
                                <div style="font-size: 16px; font-weight: bold; color: #2196f3; margin-bottom: 8px;">
                                    Payment Method Selected
                                </div>
                                <div style="color: #666; font-size: 12px; margin-bottom: 10px;">
                                    ${window.selectedPaymentDetails.cardType} ending in ${window.selectedPaymentDetails.cardEnding}
                                </div>
                                <div style="color: #666; font-size: 12px; margin-bottom: 15px;">
                                    Amount: $${paymentAmount.toFixed(2)}
                                </div>
                                <div style="display: flex; gap: 8px; justify-content: center; align-items: center;">
                                    <button id="chat-pay-now-btn" style="
                                        background: linear-gradient(135deg, #28a745, #20c997);
                                        color: white;
                                        border: none;
                                        padding: 10px 20px;
                                        border-radius: 6px;
                                        font-size: 14px;
                                        font-weight: bold;
                                        cursor: pointer;
                                    ">
                                        üí≥ Pay $${paymentAmount.toFixed(2)}
                                    </button>
                                    <button id="change-card-btn" style="
                                        background: #17a2b8;
                                        color: white;
                                        border: none;
                                        padding: 10px 16px;
                                        border-radius: 6px;
                                        font-size: 14px;
                                        cursor: pointer;
                                    ">
                                        üîÑ Change Card
                                    </button>
                                    <button onclick="location.reload()" style="
                                        background: #6c757d;
                                        color: white;
                                        border: none;
                                        padding: 10px 16px;
                                        border-radius: 6px;
                                        font-size: 14px;
                                        cursor: pointer;
                                    ">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        // Add event listener to pay button
                        document.getElementById('chat-pay-now-btn').addEventListener('click', async () => {
                            await processInlinePayment(carouselContainer);
                        });
                        
                        // Add event listener to change card button
                        document.getElementById('change-card-btn').addEventListener('click', async () => {
                            console.log('üîÑ Change card requested, re-rendering payment carousel...');
                            
                            // Show loading while re-rendering carousel
                            carouselContainer.innerHTML = '<div class="component-loading" style="text-align: center; padding: 20px; color: #666;">üîÑ Loading payment options...</div>';
                            
                            // Re-render the payment carousel in the same container
                            await new Promise(resolve => {
                                requestAnimationFrame(() => {
                                    requestAnimationFrame(resolve);
                                });
                            });
                            
                            // Clear loading and render carousel
                            carouselContainer.innerHTML = '';
                            
                            try {
                                const carouselComponent = skipifySDK.carousel(window.authenticationResult, options);
                                carouselComponent.render(carouselContainer);
                                
                                // Apply styling to carousel iframes
                                setTimeout(() => {
                                    const iframes = carouselContainer.querySelectorAll('iframe');
                                    iframes.forEach(iframe => {
                                        iframe.style.width = '100%';
                                        iframe.style.height = '280px';
                                        iframe.style.maxHeight = '280px';
                                        iframe.style.border = 'none';
                                        iframe.style.borderRadius = '4px';
                                    });
                                }, 500);
                                
                                console.log('‚úÖ Payment carousel re-rendered successfully');
                                addMessage('assistant', 'üîÑ **Payment options reloaded!** Select a different payment method or choose the same one again.');
                                
                            } catch (error) {
                                console.error('‚ùå Failed to re-render payment carousel:', error);
                                carouselContainer.innerHTML = `
                                    <div style="text-align: center; padding: 15px; color: #f44336;">
                                        <div style="font-size: 32px; margin-bottom: 10px;">‚ùå</div>
                                        <div style="font-size: 14px; font-weight: bold;">
                                            Failed to reload payment options
                                        </div>
                                        <div style="font-size: 12px; margin-top: 8px;">
                                            ${error.message}
                                        </div>
                                        <div style="margin-top: 10px;">
                                            <button onclick="location.reload()" style="background: #3498db; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">
                                                üîÑ Refresh Page
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }
                        });
                        
                        addMessage('assistant', '‚úÖ **Payment method selected!** Click "Pay Now" to complete your purchase, or "Change Card" to select a different payment method.');
                    },
                    onError: (error) => {
                        console.error('Chat carousel error:', error);
                        carouselContainer.innerHTML = `
                            <div style="text-align: center; padding: 15px; color: #f44336;">
                                <div style="font-size: 32px; margin-bottom: 10px;">‚ùå</div>
                                <div style="font-size: 14px; font-weight: bold;">Payment Options Error</div>
                                <div style="font-size: 12px; margin-top: 8px;">${error.message || error}</div>
                            </div>
                        `;
                        addMessage('assistant', `‚ùå **Carousel error:** ${error.message || error}\n\nPlease try again.`);
                    },
                    amount: carouselAmount, // Amount in cents
                    config: {
                        theme: "light",
                        fontFamily: "default",
                        fontSize: "small",
                        compact: true,
                        height: "140px"
                    }
                };

                // Render the carousel directly in the chat container
                console.log('üé® Rendering inline carousel in chat...');
                console.log('üîç Carousel container:', carouselContainer);
                console.log('üîç Container in DOM:', document.contains(carouselContainer));
                
                // Verify container is ready
                if (!document.contains(carouselContainer)) {
                    throw new Error('Carousel container not attached to DOM');
                }
                
                // Clear loading message
                carouselContainer.innerHTML = '<div class="component-loading">üí≥ Loading payment options...</div>';
                
                // Force DOM update and wait for readiness
                await new Promise(resolve => {
                    requestAnimationFrame(() => {
                        requestAnimationFrame(resolve);
                    });
                });
                
                // Clear loading and render carousel
                carouselContainer.innerHTML = '';
                
                const carouselComponent = skipifySDK.carousel(window.authenticationResult, options);
                console.log('‚úÖ Carousel component created, rendering to inline chat container...');
                
                if (carouselComponent && typeof carouselComponent.render === 'function') {
                    // Render to the inline chat container
                    carouselComponent.render(carouselContainer);
                    console.log('‚úÖ Inline carousel rendered successfully in chat!');
                } else {
                    throw new Error('Carousel component does not have render function');
                }

            } catch (error) {
                console.error('SDK carousel error:', error);
                addMessage('assistant', `‚ùå **Carousel error:** ${error.message}\n\nüí° Make sure authentication was completed first.`);
            }
        }

        async function executeSDKDeviceId(parameters) {
            if (!skipifySDK) {
                addMessage('assistant', '‚ùå **Skipify SDK not loaded** - cannot get device ID.');
                return;
            }

            try {
                const deviceId = await skipifySDK.deviceId();
                addMessage('assistant', `üì± **Device ID Retrieved:** \`${deviceId}\`

This unique identifier helps Skipify provide secure payment processing.`);
            } catch (error) {
                console.error('SDK device ID error:', error);
                addMessage('assistant', `‚ùå **Device ID error:** ${error.message}`);
            }
        }

        async function executeSDKCardSelection(parameters) {
            // Simplified version - just show a message for now
            addMessage('assistant', `üí≥ **Card selection requested!**

Please click directly on your preferred payment method in the carousel above to select it.

*Note: Automated card selection within the secure Skipify iframe is limited by browser security policies.*`);
        }

        // Manual SDK retry function
        async function retrySDKInitialization() {
            addMessage('system', 'üîß Manually retrying Skipify SDK initialization...');
            
            try {
                skipifySDK = null; // Reset SDK
                await initializeSkipifySDK();
                
                if (skipifySDK) {
                    addMessage('assistant', '‚úÖ **Payment system restored!** The Skipify SDK is now working properly. You can proceed with checkout.');
                } else {
                    addMessage('assistant', '‚ùå **Still having issues.** The SDK retry failed. Please refresh the page or contact support.');
                }
            } catch (error) {
                console.error('Manual SDK retry failed:', error);
                addMessage('assistant', `‚ùå **Retry failed:** ${error.message}\n\nPlease refresh the page completely.`);
            }
        }

        // Add a component message to chat with embedded container that renders inline 
        function addComponentMessage(sender, text, componentType, containerId) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender} component-message`;
            
            messageDiv.innerHTML = `
                <div style="margin-bottom: 8px; font-size: 14px; line-height: 1.4;">${text}</div>
                <div id="${containerId}" class="embedded-component-container inline-component" 
                     style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; padding: 6px; margin: 5px 0; min-height: 280px; max-height: 350px; height: 300px; overflow: auto; position: relative;">
                    <div class="component-loading" style="text-align: center; color: #666; padding: 15px; font-size: 13px;">
                        üîÑ Loading ${componentType}...
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            return document.getElementById(containerId);
        }

        // Session Management
        async function createSession() {
            try {
                const response = await fetch(`${window.APP_CONFIG.BACKEND_URL}/api/chat/sessions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        merchantId: '1bdc8b60-6dd4-4126-88e1-c9e5b570f1a0'
                    })
                });

                const session = await response.json();
                currentSession = session.id;
                skipifySessionId = session.skipifySessionId;

                addMessage('system', `New chat session created: ${currentSession.substring(0, 8)}...`);
                addMessage('assistant', '**Welcome to the Skipify T-Shirt Store!**\n\nI can help you shop and pay quickly and securely with Skipify Checkout.\n\n**Try saying:**\n‚Ä¢ *"Do you have Classic Cotton T-Shirts?"*\n‚Ä¢ *"Add 2 Premium Polo Shirts to my cart"*\n‚Ä¢ *"Checkout with your-email@example.com"*\n‚Ä¢ *"Process my order with my email: your-email@example.com"*\n\n**What can I help you find today?**');
            } catch (error) {
                console.error('Error creating session:', error);
                addMessage('system', 'Failed to create chat session. Please check if the backend server is running.');
            }
        }

        // Initialize everything when page loads
        window.addEventListener('load', async () => {
            console.log('Page loaded, starting initialization...');
            
            // Wait for script to load or fail
            let attempts = 0;
            while (!scriptLoaded && !scriptFailed && attempts < 30) {
                await new Promise(resolve => setTimeout(resolve, 500));
                attempts++;
                console.log(`Waiting for script loading... attempt ${attempts}/30`);
            }
            
            if (scriptFailed) {
                console.error('Script loading failed, cannot proceed');
                return;
            }
            
            // Add additional delay to ensure SDK is ready
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            console.log('Final check - Global skipify object:', typeof window.skipify);
            
            initializeStore();
            createSession();
        });

        // Additional check for SDK loading
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM content loaded');
            
            // Check if script tag loaded properly
            const skipifyScript = document.querySelector('script[src*="components-sdk.js"]');
            console.log('Skipify script tag found:', !!skipifyScript);
            if (skipifyScript) {
                console.log('Script src:', skipifyScript.src);
            }
        });
    </script>
</body>
</html>
